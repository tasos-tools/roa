<!DOCTYPE html>
<html>
<head>
    <!-- Votre CSS reste identique -->
</head>
<body>
    <!-- Votre HTML reste identique -->

    <script>
        // === CONFIG ===
        const CLIENT_ID = '1475488306534940682';
        // SUPPRIMEZ CLIENT_SECRET !
        const GUILD_ID = '942494975235592314';
        const ROLE_ID = '1475490055610175610';

        // PKCE pour s√©curit√©
        let codeVerifier = localStorage.getItem('codeVerifier');
        
        async function accessTools() {
            codeVerifier = generateCodeVerifier();
            localStorage.setItem('codeVerifier', codeVerifier);
            
            const codeChallenge = await generateCodeChallenge(codeVerifier);
            const authUrl = `https://discord.com/api/oauth2/authorize?client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(window.location.href)}&response_type=code&scope=identify%20guilds&code_challenge=${codeChallenge}&code_challenge_method=S256`;
            window.location.href = authUrl;
        }
        
        async function verifyAccess(code) {
            document.getElementById('status').textContent = 'üîÑ V√©rification...';
            document.getElementById('status').className = 'loading';
            
            try {
                // 1. √âchange code ‚Üí token (PKCE)
                const tokenResponse = await fetch('https://discord.com/api/oauth2/token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({
                        client_id: CLIENT_ID,
                        grant_type: 'authorization_code',
                        code: code,
                        redirect_uri: window.location.href,
                        code_verifier: codeVerifier
                    })
                });
                
                const tokenData = await tokenResponse.json();
                
                // 2. R√©cup√®re les serveurs de l'utilisateur
                const guildsResponse = await fetch('https://discord.com/api/users/@me/guilds', {
                    headers: { Authorization: `Bearer ${tokenData.access_token}` }
                });
                
                const guilds = await guildsResponse.json();
                
                // 3. V√©rifie pr√©sence dans le serveur
                const inGuild = guilds.some(guild => guild.id === GUILD_ID);
                
                if (inGuild) {
                    // ‚úÖ Membre du serveur ‚Üí acc√®s OK
                    showContent();
                } else {
                    throw new Error('Non membre du serveur');
                }
                
            } catch (error) {
                document.getElementById('status').innerHTML = `‚ùå Acc√®s refus√©<br>${error.message}`;
                document.getElementById('status').className = 'error';
            }
        }

        // Fonctions PKCE
        function generateCodeVerifier() {
            return Array.from(crypto.getRandomValues(new Uint8Array(32)))
                .map(b => String.fromCharCode(b % 95 + 33)).join('').slice(0, 128);
        }
        
        async function generateCodeChallenge(verifier) {
            const encoder = new TextEncoder();
            const data = encoder.encode(verifier);
            const digest = await crypto.subtle.digest('SHA-256', data);
            return btoa(String.fromCharCode(...new Uint8Array(digest)))
                .replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
        }
        
        function showContent() {
            document.getElementById('login').classList.add('hidden');
            document.getElementById('content').classList.remove('hidden');
            document.getElementById('status').textContent = '‚úÖ Acc√®s autoris√© !';
            document.getElementById('status').className = 'success';
        }

        // Auto-v√©rification au chargement
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('code')) {
            verifyAccess(urlParams.get('code'));
        }
    </script>
</body>
</html>
