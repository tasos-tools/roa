<!DOCTYPE html>
<html>
<!-- Votre head/style identique -->
<body>
    <!-- Votre HTML identique -->

    <script>
        const CLIENT_ID = '1475488306534940682';
        const GUILD_ID = '942494975235592314';

        let codeVerifier = '';

        // Au chargement
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('code')) {
            verifyAccess(urlParams.get('code'));
        }

        async function accessTools() {
            codeVerifier = generateCodeVerifier();
            localStorage.setItem('codeVerifier', codeVerifier);
            
            const codeChallenge = await generateCodeChallenge(codeVerifier);
            const authUrl = `https://discord.com/api/oauth2/authorize?client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(window.location.href)}&response_type=code&scope=identify%20guilds&code_challenge=${codeChallenge}&code_challenge_method=S256`;
            window.location.href = authUrl;
        }

        async function verifyAccess(code) {
            document.getElementById('status').textContent = 'üîÑ V√©rification...';
            document.getElementById('status').className = 'loading';
            
            try {
                // ‚úÖ PKCE = PAS DE CLIENT_SECRET
                const tokenResponse = await fetch('https://discord.com/api/oauth2/token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({
                        client_id: CLIENT_ID,
                        grant_type: 'authorization_code',
                        code: code,
                        redirect_uri: window.location.href,
                        code_verifier: codeVerifier  // ‚Üê PKCE √† la place
                    })
                });

                if (!tokenResponse.ok) {
                    const errorData = await tokenResponse.json();
                    throw new Error(`Token error: ${errorData.error || 'Unknown'}`);
                }
                
                const tokenData = await tokenResponse.json();
                
                // V√©rifie les serveurs
                const guildsResponse = await fetch('https://discord.com/api/users/@me/guilds', {
                    headers: { Authorization: `Bearer ${tokenData.access_token}` }
                });
                
                const guilds = await guildsResponse.json();
                const inGuild = guilds.some(guild => guild.id === GUILD_ID);
                
                if (inGuild) {
                    showContent();
                } else {
                    throw new Error('Non membre du serveur');
                }
                
            } catch (error) {
                console.error('Erreur compl√®te:', error);
                document.getElementById('status').innerHTML = `‚ùå Acc√®s refus√©<br>${error.message}`;
                document.getElementById('status').className = 'error';
            }
        }

        // PKCE functions
        function generateCodeVerifier() {
            let charset = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~';
            let verifier = '';
            for (let i = 0; i < 128; i++) {
                verifier += charset.charAt(Math.floor(Math.random() * charset.length));
            }
            return verifier;
        }

        async function generateCodeChallenge(verifier) {
            const encoder = new TextEncoder();
            const data = encoder.encode(verifier);
            const digest = await window.crypto.subtle.digest('SHA-256', data);
            return btoa(String.fromCharCode(...new Uint8Array(digest)))
                .replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
        }

        function showContent() {
            document.getElementById('login').classList.add('hidden');
            document.getElementById('content').classList.remove('hidden');
            document.getElementById('status').textContent = '‚úÖ Bienvenue dans Tasos Tools !';
            document.getElementById('status').className = 'success';
        }
    </script>
</body>
</html>
