<script>
// FIXED - Cl√© storage STATIQUE
const STATE_KEY = 'tasos_discord_auth';  // ‚Üê UNIQUEMENT √áA √Ä CHANGER
const CLIENT_ID = '1475488306534940682';
const GUILD_ID = '942494975235592314';

// Au chargement
window.addEventListener('load', function() {
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('code')) {
        verifyAccess(urlParams.get('code'));
    }
});

async function accessTools() {
    // Stockage SIMPLE
    sessionStorage.setItem('pkce_verifier', generateCodeVerifier());
    sessionStorage.setItem('auth_state', generateRandomString(16));
    
    const verifier = sessionStorage.getItem('pkce_verifier');
    const challenge = await generateCodeChallenge(verifier);
    
    const authUrl = `https://discord.com/api/oauth2/authorize?client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(window.location.href)}&response_type=code&scope=identify%20guilds&state=${sessionStorage.getItem('auth_state')}&code_challenge=${challenge}&code_challenge_method=S256`;
    window.location.href = authUrl;
}

async function verifyAccess(code) {
    const statusEl = document.getElementById('status');
    statusEl.textContent = 'üîÑ V√©rification...';
    statusEl.className = 'loading';
    
    const verifier = sessionStorage.getItem('pkce_verifier');
    const storedState = sessionStorage.getItem('auth_state');
    const urlState = new URLSearchParams(window.location.search).get('state');
    
    // V√©rif state
    if (storedState !== urlState) {
        statusEl.innerHTML = '‚ùå √âtat invalide';
        return;
    }
    
    if (!verifier) {
        statusEl.innerHTML = '‚ùå PKCE manquant - cliquer retry';
        return;
    }
    
    try {
        // Token exchange
        const tokenResponse = await fetch('https://discord.com/api/oauth2/token', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams({
                client_id: CLIENT_ID,
                grant_type: 'authorization_code',
                code: code,
                redirect_uri: window.location.href,
                code_verifier: verifier
            })
        });

        if (!tokenResponse.ok) throw new Error(`HTTP ${tokenResponse.status}`);
        
        const tokenData = await tokenResponse.json();
        
        // V√©rif serveur
        const guildsResponse = await fetch('https://discord.com/api/users/@me/guilds', {
            headers: { Authorization: `Bearer ${tokenData.access_token}` }
        });
        
        const guilds = await guildsResponse.json();
        const inGuild = guilds.some(guild => guild.id === GUILD_ID);
        
        if (inGuild) {
            sessionStorage.clear(); // Cleanup
            showContent();
        } else {
            statusEl.innerHTML = '‚ùå Non membre du serveur';
        }
        
    } catch (error) {
        statusEl.innerHTML = `‚ùå ${error.message}`;
    }
}

// Utils
function generateRandomString(length) {
    return Array.from(crypto.getRandomValues(new Uint8Array(length)))
        .map(b => b % 62).map(x => '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz'[x]).join('');
}

function generateCodeVerifier() {
    return Array.from(crypto.getRandomValues(new Uint8Array(64)))
        .map(b => String.fromCharCode(b % 94 + 33)).join('').slice(0, 128);
}

async function generateCodeChallenge(verifier) {
    const encoder = new TextEncoder();
    const data = encoder.encode(verifier);
    const digest = await crypto.subtle.digest('SHA-256', data);
    return btoa(String.fromCharCode(...new Uint8Array(digest)))
        .replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
}

function showContent() {
    document.getElementById('login').classList.add('hidden');
    document.getElementById('content').classList.remove('hidden');
    document.getElementById('status').textContent = '‚úÖ Acc√®s autoris√© !';
    document.getElementById('status').className = 'success';
}
</script>
